#!/bin/sh
# SPDX-FileCopyrightText: 2025 Aaron White <w531t4@gmail.com>
# SPDX-License-Identifier: MIT
# Stop on errors
set -e

cd "$(realpath "$(dirname "$0")/..")"

echo "Installing development dependencies..."

# Install esphome
uv pip install \
  -r requirements.txt \
  colorlog \
  --upgrade \
  --config-settings editable_mode=compat

# # Use this section if you need to adjust esphome sources when building.
# # If going this route, ensure you run `uv pip remove esphome`, and then python3 -m esphome (from project
# # main path
# if [ ! -d /home/vscode/depends/esphome ]; then
#         git clone \
#                 --depth 1 \
#                 --single-branch \
#                 --branch 2025.12.1 \
#                 --recurse-submodules \
#                 --shallow-submodules \
#                 --jobs 8 \
#                 https://github.com/esphome/esphome /home/vscode/depends/esphome
# fi
# ln -sf /home/vscode/depends/esphome/esphome /workspaces/ESPHome-FPGA-MatrixPanelWrapper/esphome

mkdir -p /home/vscode/depends

if [ ! -d /home/vscode/depends/ESP32-FPGA-MatrixPanel ]; then
        git clone \
                --depth 1 \
                --single-branch \
                --branch main \
                --recurse-submodules \
                --shallow-submodules \
                --jobs 8 \
                https://github.com/w531t4/ESP32-FPGA-MatrixPanel /home/vscode/depends/ESP32-FPGA-MatrixPanel
fi

for each in $(ls *.hpp *.cpp | grep -v main.cpp); do
        ln -sf /home/vscode/depends/ESP32-FPGA-MatrixPanel/src/${each} /workspaces/ESPHome-FPGA-MatrixPanelWrapper/components/fpga_matrix_display/${each}
done

if [ ! -d /home/vscode/depends/ESPHome-core_load ]; then
        git clone \
                --depth 1 \
                --single-branch \
                --branch main \
                --recurse-submodules \
                --shallow-submodules \
                --jobs 8 \
                https://github.com/w531t4/ESPHome-core_load /home/vscode/depends/ESPHome-core_load
fi

ln -sf /home/vscode/depends/ESPHome-core_load/components/core_load /workspaces/ESPHome-FPGA-MatrixPanelWrapper/components/core_load
